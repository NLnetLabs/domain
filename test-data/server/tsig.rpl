;------------ Server configuration --------------------------------------------

server:
    ; Permit the server to respond to clients that send XFR requests from
    ; 127.0.0.1 (the default). No TSIG signing is expected.
    provide-xfr: 127.0.0.1 NOKEY

    ; Permit the server to respond to clients that send XFR requests from
    ; 127.0.0.2. The requests must be TSIG signed using the specified key.
    provide-xfr: 127.0.0.2 TESTKEY

    ; Permit the server to respond to clients that send XFR requests from
    ; 127.0.0.3. The requests must be TSIG signed using the specified key.
    provide-xfr: 127.0.0.3 TESTKEY

    ; Permit the server to respond to clients that send XFR requests from
    ; 127.0.0.5. The requests must be TSIG signed using the specified key.
    ; Responses will be sent in "backward compatible" mode as defined by
    ; RFC 5936.
    ; See: https://datatracker.ietf.org/doc/html/rfc5936#section-7.1.
    provide-xfr: 127.0.0.4 TESTKEY COMPATIBLE

    ; Permit the server to respond to clients that send XFR requests from
    ; 127.0.0.4. The requests must be TSIG signed using the specified key.
    provide-xfr: 127.0.0.5 TESTKEY

    ; Define an in-memory zone to be served by the server.
    local-data: "example.com.      3600  IN  SOA  ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600"
    local-data: "example.com.      3600  IN  NS   ns.example.net."
    local-data: "www.example.com.  3600  IN  A    1.2.3.4"
CONFIG_END

;------------ Test definition ------------------------------------------------

SCENARIO_BEGIN Test TSIG signed queries and TSIG signed AXFR replies.

;--- Mock replies

; None

;--- Test steps

; Verify that when the default 127.0.0.1 client submits an AXFR request over
; UDP that it is rejected (because AXFR over UDP is not defined by RFC 5936).
; See: https://datatracker.ietf.org/doc/html/rfc5936#section-4.2
STEP 10 QUERY
ENTRY_BEGIN
MATCH UDP
SECTION QUESTION
    example.com.            IN  AXFR
ENTRY_END

STEP 11 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR AA REFUSED
ENTRY_END

; Verify that when a client that is required to TSIG sign requests (127.0.0.2)
; submits an unsigned AXFR request over TCP that it is rejected (because while
; AXFR over TCP is allowed, the request is required to be correctly signed).
STEP 20 QUERY ADDRESS 127.0.0.2
ENTRY_BEGIN
MATCH TCP
SECTION QUESTION
    example.com.            IN  AXFR
ENTRY_END

STEP 21 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR AA REFUSED
ENTRY_END

; Retrieve the zone via AXFR over TCP using the expected TSIG key.
STEP 30 QUERY ADDRESS 127.0.0.3 KEY TESTKEY
ENTRY_BEGIN
MATCH TCP
SECTION QUESTION
    example.com.            IN  AXFR
ENTRY_END

STEP 31 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR AA NOERROR
SECTION QUESTION
    example.com.            IN  AXFR
SECTION ANSWER
    example.com.      3600  IN  SOA  ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
    example.com.      3600  IN  NS   ns.example.net.
    www.example.com.  3600  IN  A    1.2.3.4
    example.com.      3600  IN  SOA  ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
ENTRY_END

; Retrieve the zone using a client for which the server is configured to serve
; AXFR in backward compatible mode so that we can test multi-response TSIG.
STEP 40 QUERY ADDRESS 127.0.0.4 KEY TESTKEY
ENTRY_BEGIN
MATCH TCP
SECTION QUESTION
    example.com.            IN  AXFR
ENTRY_END

STEP 41 CHECK_ANSWER
ENTRY_BEGIN
MATCH all EXTRA_PACKETS
REPLY QR AA NOERROR
SECTION QUESTION
    example.com.            IN  AXFR
SECTION ANSWER
    example.com.      3600  IN  SOA  ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
    www.example.com.  3600  IN  A    1.2.3.4
    example.com.      3600  IN  NS   ns.example.net.
    example.com.      3600  IN  SOA  ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
ENTRY_END

; NOTE: See test-data/server/README.md regarding the effect of MOCK_CLIENT
; that is used here.
STEP 50 QUERY ADDRESS 127.0.0.5
ENTRY_BEGIN
MATCH UDP
MATCH MOCK_CLIENT
SECTION QUESTION
    example.com.            IN  SOA
SECTION ADDITIONAL
; Stelline doesn't support parsing zone entries that use the ( multiline )
; format, otherwise we could use here.
    TESTKEY           0     CLASS255  TYPE250  \# 61 0b686d61632d73686132353600 000000000000 012c 0020 a1c86ced1815d60903129a525a14494516895d99ea94bf0b5b04338126a4d625 0000 0000 0000
;                                                                                                                                                                                 ^ Other Len
;                                                                                                                                                                            ^ Error
;                                                                                                                                                                       ^ Original ID
;                                                                                                      ^ MAC
;                                                                                                 ^ MAC Size
;                                                                                            ^ Fudge
;                                                    ^ Algorithm Name           ^ Time Signed
;                                                 ^ RDATA byte length.
;                           ^ RFC 3597 CLASSNN TYPENN \# encoding of unknown DNS RR types.
;                             We use this so that we can define the RDATA using HEX bytes.
ENTRY_END

STEP 51 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR NOERROR
SECTION QUESTION
    example.com.            IN  SOA
SECTION ANSWER
    example.com.      3600  IN  SOA  ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
SECTION ADDITIONAL
    TESTKEY           0     CLASS255  TYPE250  \# 61 0b686d61632d73686132353600 000000000000 012c 0020 6d7f9c5a14c2b48d4a0549000af29808e5eb25f7a80c22a2b1c0cf2ef3929bcd 0000 0000 0000
ENTRY_END

SCENARIO_END