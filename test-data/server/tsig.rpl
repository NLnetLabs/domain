; config options
server:
	provide-xfr: 127.0.0.1 NOKEY
    provide-xfr: 127.0.0.2 TESTKEY
    provide-xfr: 127.0.0.3 TESTKEY
	provide-xfr: 127.0.0.4 TESTKEY COMPATIBLE
	local-data: "example.com.	3600	IN	SOA	ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600"
	local-data: "example.com.	3600	IN	NS	ns.example.net."
	local-data: "www.example.com.	3600	IN	A	1.2.3.4"

CONFIG_END

SCENARIO_BEGIN Test TSIG signed AXFR out

; Verify that when the default 127.0.0.1 client submits an un-TSIG-signed AXFR
; request over UDP that it is rejected (because AXFR over UDP is not supported).
STEP 10 QUERY
ENTRY_BEGIN
MATCH UDP
SECTION QUESTION
	example.com. IN AXFR
ENTRY_END

STEP 11 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR AA REFUSED
ENTRY_END

; Verify that when a client that is required to TSIG sign requests (127.0.0.2)
; submits an unsigned AXFR request over TCP that it is rejected (because while
; AXFR over TCP is allowed, the request is required to be correctly signed)
STEP 20 QUERY ADDRESS 127.0.0.2
ENTRY_BEGIN
MATCH TCP
SECTION QUESTION
	example.com. IN AXFR
ENTRY_END

STEP 21 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR AA REFUSED
ENTRY_END

; Retrieve the zone via AXFR from the server using the required TSIG key.
STEP 30 QUERY ADDRESS 127.0.0.3 KEY TESTKEY
ENTRY_BEGIN
MATCH TCP
SECTION QUESTION
	example.com. IN AXFR
ENTRY_END

STEP 31 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR AA NOERROR
SECTION QUESTION
	example.com. IN AXFR
SECTION ANSWER
	example.com.	3600	IN	SOA	ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
	example.com.	3600	IN	NS	ns.example.net.
	www.example.com.	3600	IN	A	1.2.3.4
	example.com.	3600	IN	SOA	ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
ENTRY_END

; Retrieve the zone using a client for which the server is configured to serve
; AXFR in backward compatible mode so that we can test multi-response TSIG.
STEP 40 QUERY ADDRESS 127.0.0.4 KEY TESTKEY
ENTRY_BEGIN
MATCH TCP
SECTION QUESTION
	example.com. IN AXFR
ENTRY_END

STEP 41 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR AA NOERROR
SECTION QUESTION
	example.com. IN AXFR
SECTION ANSWER
	example.com.	3600	IN	SOA	ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
EXTRA_PACKET
	example.com.	3600	IN	NS	ns.example.net.
EXTRA_PACKET
	www.example.com.	3600	IN	A	1.2.3.4
EXTRA_PACKET
	example.com.	3600	IN	SOA	ns.example.com. hostmaster.example.com. 1 3600 900 86400 3600
ENTRY_END

SCENARIO_END