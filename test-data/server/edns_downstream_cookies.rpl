; Based on: https://github.com/NLnetLabs/unbound/blob/49e425810275917e7fd09a24bae3b97d83b55c13/testdata/edns_downstream_cookies.rpl

;------------ Server configuration --------------------------------------------

server:
    answer-cookie: yes
    cookie-secret: "000102030405060708090a0b0c0d0e0f"
    access-control: 127.0.0.1 allow_cookie
    access-control: 1.2.3.4 allow

    ; Define an in-memory zone to be served by the server.
    local-data: "test.  3600  IN  SOA  ns.test. hostmaster.test. 1 3600 900 86400 3600"
    local-data: "test.            TXT  test"

CONFIG_END

;------------ Test definition ------------------------------------------------

SCENARIO_BEGIN Test RFC 7873 DNS cookies support.

;--- Mock replies

; None

;--- Test steps

; Query without a client cookie ...
STEP 10 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
ENTRY_END
; ... get TC and refused
STEP 11 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR RD TC REFUSED
SECTION QUESTION
test. IN TXT
ENTRY_END

; Query without a client cookie on TCP ...
STEP 20 QUERY
ENTRY_BEGIN
REPLY RD
MATCH TCP
SECTION QUESTION
test. IN TXT
ENTRY_END
; ... get an answer
STEP 21 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR RD AA NOERROR
SECTION QUESTION
test. IN TXT
SECTION ANSWER
test. IN TXT "test"
ENTRY_END

; Query with only a client cookie ...
STEP 30 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
SECTION ADDITIONAL
HEX_EDNSDATA_BEGIN
    00 0a            ; Opcode 10
    00 08            ; Length 8
    31 32 33 34 35 36 37 38    ; Random bits
HEX_EDNSDATA_END
ENTRY_END
; ... get BADCOOKIE and a new cookie
STEP 31 CHECK_ANSWER
ENTRY_BEGIN
MATCH all server_cookie
REPLY QR RD DO YXRRSET=BADCOOKIE    ; BADCOOKIE is an extended rcode (NOTE: THIS YXRRSET=XXX SYNTAX IS A CUSTOM DOMAIN EXTENSION TO .RPL FORMAT)
SECTION QUESTION
test. IN TXT
ENTRY_END

; Query with an invalid cookie ...
STEP 40 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
SECTION ADDITIONAL
HEX_EDNSDATA_BEGIN
    00 0a            ; Opcode 10
    00 18            ; Length 24
    31 32 33 34 35 36 37 38    ; Random bits
    02 00 00 00        ; wrong version
    00 00 00 00        ; Timestamp
    31 32 33 34 35 36 37 38    ; wrong hash
HEX_EDNSDATA_END
ENTRY_END
; ... get BADCOOKIE and a new cookie
STEP 41 CHECK_ANSWER
ENTRY_BEGIN
MATCH all server_cookie
REPLY QR RD DO YXRRSET=BADCOOKIE    ; BADCOOKIE is an extended rcode (NOTE: THIS YXRRSET=XXX SYNTAX IS A CUSTOM DOMAIN EXTENSION TO .RPL FORMAT)
SECTION QUESTION
test. IN TXT
ENTRY_END

; Query with an invalid cookie from a non-cookie protected address ...
STEP 50 QUERY ADDRESS 1.2.3.4
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
SECTION ADDITIONAL
HEX_EDNSDATA_BEGIN
    00 0a            ; Opcode 10
    00 18            ; Length 24
    31 32 33 34 35 36 37 38    ; Random bits
    02 00 00 00        ; wrong version
    00 00 00 00        ; Timestamp
    31 32 33 34 35 36 37 38    ; wrong hash
HEX_EDNSDATA_END
ENTRY_END
; ... get answer and a cookie
STEP 51 CHECK_ANSWER
ENTRY_BEGIN
MATCH all server_cookie
REPLY QR RD AA DO NOERROR
SECTION QUESTION
test. IN TXT
SECTION ANSWER
test. IN TXT "test"
ENTRY_END

; Query with a valid cookie ...
STEP 60 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
SECTION ADDITIONAL
HEX_EDNSDATA_BEGIN
    00 0a            ; Opcode 10
    00 18            ; Length 24
    31 32 33 34 35 36 37 38    ; Random bits
    01 00 00 00        ; Version/Reserved
    00 00 00 00        ; Timestamp
    38 52 7b a8 c6 a4 ea 96    ; Hash
HEX_EDNSDATA_END
ENTRY_END
; ... get answer and the cookie
STEP 61 CHECK_ANSWER
ENTRY_BEGIN
MATCH all server_cookie
REPLY QR RD AA DO NOERROR
SECTION QUESTION
test. IN TXT
SECTION ANSWER
test. IN TXT "test"
ENTRY_END

; Query with a valid >30 minutes old cookie ...
STEP 70 TIME_PASSES ELAPSE 1801
STEP 80 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
SECTION ADDITIONAL
HEX_EDNSDATA_BEGIN
    00 0a            ; Opcode 10
    00 18            ; Length 24
    31 32 33 34 35 36 37 38    ; Random bits
    01 00 00 00        ; Version/Reserved
    00 00 00 00        ; Timestamp
    38 52 7b a8 c6 a4 ea 96    ; Hash
HEX_EDNSDATA_END
ENTRY_END
; ... Get answer and a refreshed cookie
;     (we don't check the re-freshness here; it has its own unit test)
STEP 81 CHECK_ANSWER
ENTRY_BEGIN
MATCH all server_cookie
REPLY QR RD AA DO NOERROR
SECTION QUESTION
test. IN TXT
SECTION ANSWER
test. IN TXT "test"
ENTRY_END

; Query with a hash-valid >60 minutes old cookie ...
STEP 90 TIME_PASSES ELAPSE 3601
STEP 100 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
SECTION ADDITIONAL
HEX_EDNSDATA_BEGIN
    00 0a            ; Opcode 10
    00 18            ; Length 24
    31 32 33 34 35 36 37 38    ; Random bits
    01 00 00 00        ; Version/Reserved
    00 00 07 09        ; Timestamp (1801)
    77 81 38 e3 8f aa 72 86    ; Hash
HEX_EDNSDATA_END
ENTRY_END
; ... get BADCOOKIE and a new cookie
STEP 101 CHECK_ANSWER
ENTRY_BEGIN
MATCH all server_cookie
REPLY QR RD DO YXRRSET=BADCOOKIE    ; BADCOOKIE is an extended rcode (NOTE: THIS YXRRSET=XXX SYNTAX IS A CUSTOM DOMAIN EXTENSION TO .RPL FORMAT)
SECTION QUESTION
test. IN TXT
ENTRY_END

; Query with a valid future (<5 minutes) cookie ...
STEP 110 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
test. IN TXT
SECTION ADDITIONAL
HEX_EDNSDATA_BEGIN
    00 0a            ; Opcode 10
    00 18            ; Length 24
    31 32 33 34 35 36 37 38    ; Random bits
    01 00 00 00        ; Version/Reserved
    00 00 16 45        ; Timestamp (1801 + 3601 + 299)
    4a f5 0f df f0 e8 c7 09    ; Hash
HEX_EDNSDATA_END
ENTRY_END
; ... get an answer
STEP 111 CHECK_ANSWER
ENTRY_BEGIN
MATCH all server_cookie
REPLY QR RD AA DO NOERROR
SECTION QUESTION
test. IN TXT
SECTION ANSWER
test. IN TXT "test"
ENTRY_END

SCENARIO_END
